# Исправление проблемы с миграциями

## Проблема

Ошибка: `OperationalError: no such column: main_page_backgroundvideo.name`

Это происходит потому, что:

1. Миграции были пересозданы (удалены старые миграции 0002-0005)
2. База данных SQLite содержит старую структуру таблицы
3. Django считает, что миграция 0001_initial уже применена

## Решение для разработки (SQLite)

### Вариант 1: Пересоздать базу данных (РЕКОМЕНДУЕТСЯ для dev)

1. **Остановите сервер разработки Django** (Ctrl+C в терминале где запущен `python manage.py runserver`)

2. **Удалите базу данных SQLite:**

   ```bash
   cd backend
   del db.sqlite3  # для Windows
   # или rm db.sqlite3  # для Linux/Mac
   ```

3. **Применить миграции заново:**

   ```bash
   python manage.py migrate
   ```

4. **Создать нового суперпользователя:**

   ```bash
   python manage.py createsuperuser
   ```

5. **Запустить сервер:**
   ```bash
   python manage.py runserver
   ```

### Вариант 2: Откатить миграции и применить заново

Если вы хотите сохранить данные, используйте этот метод:

1. **Остановите сервер разработки**

2. **Откатите миграции main_page:**

   ```bash
   cd backend
   venv\Scripts\activate  # активируйте виртуальное окружение
   python manage.py migrate main_page zero
   ```

3. **Примените миграции заново:**

   ```bash
   python manage.py migrate main_page
   ```

4. **Проверьте другие приложения:**
   ```bash
   python manage.py migrate
   ```

## Решение для продакшна (PostgreSQL)

На продакшне с PostgreSQL нужно быть осторожнее:

1. **Создайте бэкап базы данных:**

   ```bash
   pg_dump -U postgres -d notarius > backup_$(date +%Y%m%d_%H%M%S).sql
   ```

2. **Откатите миграции:**

   ```bash
   python manage.py migrate main_page zero
   ```

3. **Примените новые миграции:**
   ```bash
   python manage.py migrate main_page
   python manage.py migrate
   ```

## Проверка

После применения миграций проверьте:

1. **Проверьте структуру таблицы:**

   ```bash
   python manage.py dbshell
   ```

   Для SQLite:

   ```sql
   .schema main_page_backgroundvideo
   ```

   Для PostgreSQL:

   ```sql
   \d main_page_backgroundvideo
   ```

2. **Откройте админку:** http://localhost:8000/admin/main_page/backgroundvideo/

   - Не должно быть ошибки

3. **Проверьте API:** http://localhost:8000/api/background-videos/
   - Должен вернуть пустой массив `[]` или данные если есть

## Обновление компонента MainVideo

Компонент `MainVideo` был обновлен для работы с API:

### Что изменилось:

- ✅ Загружает данные с API `/api/background-videos/`
- ✅ Поддерживает и видео, и изображения
- ✅ Автоматически выбирает активный медиа-файл (`is_active: true`)
- ✅ Имеет fallback на локальное видео при ошибке
- ✅ Использует API_BASE_URL из конфигурации

### Как использовать в админке:

1. Перейдите в админку: http://localhost:8000/admin/
2. Откройте "Фоновые медиа" (BackgroundVideo)
3. Создайте новый элемент:
   - **Название**: "Главное видео" (или любое другое)
   - **Тип медиа**: Выберите "Видео" или "Изображение"
   - **Видеофайл**: Загрузите видео (если выбрали "Видео")
   - **Изображение**: Загрузите изображение (если выбрали "Изображение")
   - **Активно**: ✅ (галочка)
4. Сохраните

Компонент автоматически подхватит изменения и отобразит выбранный медиа-файл.

## Примечания

- Для разработки используйте SQLite (как сейчас)
- Для продакшна используется PostgreSQL (согласно настройкам)
- Миграции применяются автоматически на Railway при деплое
- Всегда делайте бэкап перед изменением миграций в продакшне
